#!/bin/bash
# Docker Container Deployment Script
# Generated from template: deployment/docker_deploy

set -e
set -u
set -o pipefail

# Configuration
IMAGE="{{ image }}"
CONTAINER_NAME="{{ container_name }}"
PORT="{{ port | default(8080) }}"
ENV_FILE="{{ env_file | default('') }}"
VOLUMES="{{ volumes | default('') }}"
NETWORK="{{ network | default('bridge') }}"

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1"
}

log "Starting Docker deployment for ${CONTAINER_NAME}"

# Stop and remove existing container if it exists
if docker ps -a | grep -q "${CONTAINER_NAME}"; then
    log "Stopping existing container..."
    docker stop "${CONTAINER_NAME}" || true
    docker rm "${CONTAINER_NAME}" || true
fi

# Pull latest image
log "Pulling image: ${IMAGE}"
docker pull "${IMAGE}"

# Build docker run command
CMD="docker run -d --name ${CONTAINER_NAME}"
CMD="${CMD} -p ${PORT}:${PORT}"
CMD="${CMD} --network ${NETWORK}"

{% if env_file %}
CMD="${CMD} --env-file ${ENV_FILE}"
{% endif %}

{% if volumes %}
CMD="${CMD} ${VOLUMES}"
{% endif %}

CMD="${CMD} ${IMAGE}"

# Run container
log "Starting container..."
eval ${CMD}

# Verify container is running
sleep 2
if docker ps | grep -q "${CONTAINER_NAME}"; then
    log "✓ Container ${CONTAINER_NAME} deployed successfully"
    docker ps | grep "${CONTAINER_NAME}"
    exit 0
else
    log "✗ ERROR: Container failed to start"
    docker logs "${CONTAINER_NAME}"
    exit 1
fi
