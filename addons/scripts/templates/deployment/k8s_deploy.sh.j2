#!/bin/bash
# Kubernetes Deployment Script
# Generated from template: deployment/k8s_deploy

set -e
set -u
set -o pipefail

# Configuration
NAMESPACE="{{ namespace }}"
DEPLOYMENT="{{ deployment }}"
IMAGE="{{ image }}"
REPLICAS="{{ replicas | default(3) }}"
MANIFEST="{{ manifest | default('') }}"

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1"
}

log "Starting Kubernetes deployment"

# Create namespace if it doesn't exist
if ! kubectl get namespace "${NAMESPACE}" > /dev/null 2>&1; then
    log "Creating namespace: ${NAMESPACE}"
    kubectl create namespace "${NAMESPACE}"
fi

{% if manifest %}
# Apply manifest file
log "Applying manifest: ${MANIFEST}"
kubectl apply -f "${MANIFEST}" -n "${NAMESPACE}"
{% else %}
# Update deployment image
log "Updating deployment ${DEPLOYMENT} with image ${IMAGE}"
kubectl set image deployment/${DEPLOYMENT} \
    ${DEPLOYMENT}=${IMAGE} \
    -n "${NAMESPACE}"
{% endif %}

# Wait for rollout to complete
log "Waiting for rollout to complete..."
kubectl rollout status deployment/${DEPLOYMENT} -n "${NAMESPACE}" --timeout=5m

# Verify deployment
READY=$(kubectl get deployment ${DEPLOYMENT} -n "${NAMESPACE}" -o jsonpath='{.status.readyReplicas}')
log "Deployment complete: ${READY} replicas ready"

# Show pod status
log "Pod status:"
kubectl get pods -n "${NAMESPACE}" -l app="${DEPLOYMENT}"

exit 0
