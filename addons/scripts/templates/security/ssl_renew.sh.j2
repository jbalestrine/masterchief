#!/bin/bash
# SSL Certificate Renewal Script
# Generated from template: security/ssl_renew

set -e
set -u
set -o pipefail

# Configuration
DOMAIN="{{ domain }}"
EMAIL="{{ email }}"
WEBROOT="{{ webroot | default('/var/www/html') }}"
CERT_PATH="{{ cert_path | default('/etc/letsencrypt/live') }}"
RELOAD_CMD="{{ reload_cmd | default('systemctl reload nginx') }}"

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1"
}

log "Starting SSL certificate renewal for ${DOMAIN}"

# Check if certificate exists and when it expires
if [ -d "${CERT_PATH}/${DOMAIN}" ]; then
    EXPIRY=$(openssl x509 -enddate -noout -in "${CERT_PATH}/${DOMAIN}/cert.pem" | cut -d= -f2)
    EXPIRY_EPOCH=$(date -d "${EXPIRY}" +%s)
    CURRENT_EPOCH=$(date +%s)
    DAYS_LEFT=$(( (EXPIRY_EPOCH - CURRENT_EPOCH) / 86400 ))
    
    log "Certificate expires in ${DAYS_LEFT} days"
    
    if [ ${DAYS_LEFT} -gt 30 ]; then
        log "Certificate is still valid for more than 30 days. Skipping renewal."
        exit 0
    fi
fi

# Renew certificate using certbot
log "Renewing certificate..."
if certbot certonly --webroot \
    -w "${WEBROOT}" \
    -d "${DOMAIN}" \
    --email "${EMAIL}" \
    --agree-tos \
    --non-interactive \
    --quiet; then
    
    log "✓ Certificate renewed successfully"
    
    # Reload web server
    log "Reloading web server..."
    eval "${RELOAD_CMD}"
    
    log "✓ SSL renewal complete"
    exit 0
else
    log "✗ ERROR: Certificate renewal failed"
    exit 1
fi
