#!/bin/bash
# Security Audit Log Script
# Generated from template: security/audit_logs

set -e
set -u

# Configuration
LOG_DIR="{{ log_dir | default('/var/log/audit') }}"
DAYS_TO_KEEP="{{ days_to_keep | default(90) }}"
REPORT_FILE="{{ report_file | default('/tmp/audit_report.txt') }}"
SEARCH_PATTERNS="{{ search_patterns | default('Failed password,authentication failure,Invalid user') }}"

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1"
}

log "Starting security audit log analysis"

# Create report header
cat > "${REPORT_FILE}" << EOF
Security Audit Report
Generated: $(date)
=====================================

EOF

# Search for suspicious patterns
IFS=',' read -ra PATTERNS <<< "${SEARCH_PATTERNS}"

for PATTERN in "${PATTERNS[@]}"; do
    PATTERN=$(echo "${PATTERN}" | xargs)  # Trim whitespace
    log "Searching for: ${PATTERN}"
    
    echo "## Pattern: ${PATTERN}" >> "${REPORT_FILE}"
    
    MATCHES=$(grep -r "${PATTERN}" "${LOG_DIR}" 2>/dev/null | wc -l || echo "0")
    echo "Found ${MATCHES} matches" >> "${REPORT_FILE}"
    
    if [ ${MATCHES} -gt 0 ]; then
        grep -r "${PATTERN}" "${LOG_DIR}" 2>/dev/null | tail -n 10 >> "${REPORT_FILE}"
    fi
    
    echo "" >> "${REPORT_FILE}"
done

# Archive old logs
log "Archiving logs older than ${DAYS_TO_KEEP} days"
find "${LOG_DIR}" -name "*.log" -mtime +${DAYS_TO_KEEP} -exec gzip {} \;

log "Audit report generated: ${REPORT_FILE}"
cat "${REPORT_FILE}"

exit 0
