#!/bin/bash
# Disk Usage Monitoring Script
# Generated from template: monitoring/disk_usage

set -e
set -u

# Configuration
THRESHOLD="{{ threshold | default(90) }}"
EMAIL="{{ email | default('') }}"
LOG_FILE="{{ log_file | default('/var/log/disk_usage.log') }}"

# Check disk usage
USAGE=$(df -h / | awk 'NR==2 {print $5}' | sed 's/%//')

echo "[$(date)] Disk usage: ${USAGE}%" >> "${LOG_FILE}"

if [ "${USAGE}" -gt "${THRESHOLD}" ]; then
    MESSAGE="WARNING: Disk usage is at ${USAGE}%, exceeding threshold of ${THRESHOLD}%"
    echo "${MESSAGE}" >> "${LOG_FILE}"
    
    {% if email %}
    # Send email alert
    echo "${MESSAGE}" | mail -s "Disk Usage Alert" "${EMAIL}"
    {% endif %}
    
    exit 1
else
    echo "[$(date)] Disk usage is OK (${USAGE}%)" >> "${LOG_FILE}"
    exit 0
fi
