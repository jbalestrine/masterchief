#!/bin/bash
# Log Monitoring Script
# Generated from template: monitoring/log_monitor

set -e
set -u

# Configuration
LOG_FILE="{{ log_file }}"
PATTERN="{{ pattern }}"
ACTION="{{ action | default('alert') }}"
EMAIL="{{ email | default('') }}"
ALERT_FILE="{{ alert_file | default('/tmp/log_alert.txt') }}"

# Check if log file exists
if [ ! -f "${LOG_FILE}" ]; then
    echo "ERROR: Log file not found: ${LOG_FILE}"
    exit 1
fi

# Search for pattern
MATCHES=$(grep -c "${PATTERN}" "${LOG_FILE}" || true)

if [ ${MATCHES} -gt 0 ]; then
    MESSAGE="Found ${MATCHES} occurrences of '${PATTERN}' in ${LOG_FILE}"
    echo "${MESSAGE}"
    
    # Extract matching lines
    grep "${PATTERN}" "${LOG_FILE}" > "${ALERT_FILE}"
    
    {% if email %}
    # Send email alert
    cat "${ALERT_FILE}" | mail -s "Log Alert: ${PATTERN}" "${EMAIL}"
    {% endif %}
    
    exit 1
else
    echo "No matches found for pattern: ${PATTERN}"
    exit 0
fi
