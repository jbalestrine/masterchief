#!/bin/bash
# Service Health Check Script
# Generated from template: monitoring/service_health

set -e
set -u

# Configuration
SERVICE="{{ service_name }}"
MAX_RETRIES="{{ max_retries | default(3) }}"
RETRY_DELAY="{{ retry_delay | default(5) }}"
LOG_FILE="{{ log_file | default('/var/log/service_health.log') }}"

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "${LOG_FILE}"
}

check_service() {
    systemctl is-active --quiet "${SERVICE}"
    return $?
}

# Main health check logic
for i in $(seq 1 ${MAX_RETRIES}); do
    if check_service; then
        log "✓ Service ${SERVICE} is healthy"
        exit 0
    else
        log "✗ Service ${SERVICE} is not running (attempt ${i}/${MAX_RETRIES})"
        
        if [ ${i} -lt ${MAX_RETRIES} ]; then
            log "Waiting ${RETRY_DELAY}s before retry..."
            sleep ${RETRY_DELAY}
        fi
    fi
done

# Service is down after all retries
log "ERROR: Service ${SERVICE} is down after ${MAX_RETRIES} attempts"

{% if auto_restart | default(false) %}
log "Attempting to restart service..."
if systemctl restart "${SERVICE}"; then
    log "Service ${SERVICE} restarted successfully"
    exit 0
else
    log "ERROR: Failed to restart service ${SERVICE}"
    exit 1
fi
{% else %}
exit 1
{% endif %}
