#!/bin/bash
# Log Rotation and Cleanup Script
# Generated from template: maintenance/log_rotation

set -e
set -u

# Configuration
LOG_DIR="{{ log_dir }}"
MAX_SIZE="{{ max_size | default(100) }}"  # MB
RETENTION_DAYS="{{ retention_days | default(30) }}"
COMPRESS="{{ compress | default(true) }}"

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1"
}

log "Starting log rotation and cleanup for ${LOG_DIR}"

# Check if directory exists
if [ ! -d "${LOG_DIR}" ]; then
    log "ERROR: Directory not found: ${LOG_DIR}"
    exit 1
fi

# Rotate large log files
find "${LOG_DIR}" -name "*.log" -type f -size +${MAX_SIZE}M | while read -r LOGFILE; do
    log "Rotating large log file: ${LOGFILE}"
    TIMESTAMP=$(date +%Y%m%d_%H%M%S)
    ROTATED="${LOGFILE}.${TIMESTAMP}"
    
    mv "${LOGFILE}" "${ROTATED}"
    touch "${LOGFILE}"
    
    {% if compress %}
    gzip "${ROTATED}"
    log "Compressed: ${ROTATED}.gz"
    {% endif %}
done

# Delete old log files
log "Deleting logs older than ${RETENTION_DAYS} days"
DELETED=$(find "${LOG_DIR}" -name "*.log*" -mtime +${RETENTION_DAYS} -delete -print | wc -l)
log "Deleted ${DELETED} old log files"

# Calculate total space used
SPACE_USED=$(du -sh "${LOG_DIR}" | cut -f1)
log "Total space used by logs: ${SPACE_USED}"

log "Log rotation and cleanup completed"
exit 0
