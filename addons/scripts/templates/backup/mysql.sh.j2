#!/bin/bash
# MySQL Database Backup Script
# Generated from template: backup/mysql

set -e
set -u
set -o pipefail

# Configuration
DATABASE="{{ database }}"
BACKUP_DIR="{{ backup_dir }}"
RETENTION_DAYS="{{ retention_days | default(7) }}"
MYSQL_USER="{{ mysql_user | default('root') }}"
MYSQL_PASSWORD="{{ mysql_password | default('') }}"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="${BACKUP_DIR}/${DATABASE}_${TIMESTAMP}.sql.gz"

# Create backup directory
mkdir -p "${BACKUP_DIR}"

echo "Starting MySQL backup for database: ${DATABASE}"

# Perform backup with compression
if mysqldump -u"${MYSQL_USER}" -p"${MYSQL_PASSWORD}" \
    --single-transaction \
    --routines \
    --triggers \
    --events \
    "${DATABASE}" | gzip > "${BACKUP_FILE}"; then
    echo "Backup completed: ${BACKUP_FILE}"
else
    echo "ERROR: Backup failed"
    exit 1
fi

# Clean up old backups
find "${BACKUP_DIR}" -name "${DATABASE}_*.sql.gz" -mtime +${RETENTION_DAYS} -delete

echo "Backup process completed"
exit 0
