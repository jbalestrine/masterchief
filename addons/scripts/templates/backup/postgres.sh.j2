#!/bin/bash
# PostgreSQL Database Backup Script
# Generated from template: backup/postgres

set -e
set -u
set -o pipefail

# Configuration
DATABASE="{{ database }}"
BACKUP_DIR="{{ backup_dir }}"
RETENTION_DAYS="{{ retention_days | default(7) }}"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="${BACKUP_DIR}/${DATABASE}_${TIMESTAMP}.sql.gz"
LOG_FILE="${BACKUP_DIR}/backup_${TIMESTAMP}.log"

# Create backup directory if it doesn't exist
mkdir -p "${BACKUP_DIR}"

# Log function
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "${LOG_FILE}"
}

log "Starting PostgreSQL backup for database: ${DATABASE}"

# Perform backup with compression
if pg_dump "${DATABASE}" | gzip > "${BACKUP_FILE}"; then
    BACKUP_SIZE=$(du -h "${BACKUP_FILE}" | cut -f1)
    log "Backup completed successfully: ${BACKUP_FILE} (${BACKUP_SIZE})"
else
    log "ERROR: Backup failed"
    exit 1
fi

# Verify backup integrity
if gunzip -t "${BACKUP_FILE}"; then
    log "Backup integrity verified"
else
    log "ERROR: Backup integrity check failed"
    exit 1
fi

# Clean up old backups
log "Cleaning up backups older than ${RETENTION_DAYS} days"
find "${BACKUP_DIR}" -name "${DATABASE}_*.sql.gz" -type f -mtime +${RETENTION_DAYS} -delete

# Count remaining backups
BACKUP_COUNT=$(find "${BACKUP_DIR}" -name "${DATABASE}_*.sql.gz" -type f | wc -l)
log "Current backup count: ${BACKUP_COUNT}"

log "Backup process completed successfully"

exit 0
