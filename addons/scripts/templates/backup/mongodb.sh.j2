#!/bin/bash
# MongoDB Database Backup Script
# Generated from template: backup/mongodb

set -e
set -u
set -o pipefail

# Configuration
DATABASE="{{ database }}"
BACKUP_DIR="{{ backup_dir }}"
RETENTION_DAYS="{{ retention_days | default(7) }}"
MONGO_HOST="{{ mongo_host | default('localhost') }}"
MONGO_PORT="{{ mongo_port | default(27017) }}"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
BACKUP_PATH="${BACKUP_DIR}/${DATABASE}_${TIMESTAMP}"

# Create backup directory
mkdir -p "${BACKUP_DIR}"

echo "Starting MongoDB backup for database: ${DATABASE}"

# Perform backup
if mongodump --host "${MONGO_HOST}:${MONGO_PORT}" \
    --db "${DATABASE}" \
    --out "${BACKUP_PATH}"; then
    
    # Compress backup
    tar -czf "${BACKUP_PATH}.tar.gz" -C "${BACKUP_DIR}" "${DATABASE}_${TIMESTAMP}"
    rm -rf "${BACKUP_PATH}"
    
    echo "Backup completed: ${BACKUP_PATH}.tar.gz"
else
    echo "ERROR: Backup failed"
    exit 1
fi

# Clean up old backups
find "${BACKUP_DIR}" -name "${DATABASE}_*.tar.gz" -mtime +${RETENTION_DAYS} -delete

echo "Backup process completed"
exit 0
