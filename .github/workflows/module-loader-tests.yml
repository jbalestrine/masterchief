name: Module Loader Tests

on:
  push:
    paths:
      - 'core/module_loader/**'
      - 'core/config/**'
      - '.github/workflows/module-loader-tests.yml'
  pull_request:
    paths:
      - 'core/**'

jobs:
  test:
    name: Test Module Loader
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: |
          pip install pyyaml

      - name: Test Module Discovery
        run: |
          python3 << 'EOF'
          import sys
          import os
          sys.path.insert(0, os.getcwd())
          
          from core.config.manager import ConfigManager
          
          # Test configuration manager
          print("Testing ConfigManager...")
          config_mgr = ConfigManager("core/config")
          
          # Load global config
          global_config = config_mgr.load_global_config()
          print(f"✓ Loaded global config with {len(global_config)} keys")
          
          # Load dev environment
          config_mgr.load_environment("dev")
          print("✓ Loaded dev environment")
          
          # Test configuration retrieval
          azure_region = config_mgr.get_config("dev", "azure.region")
          print(f"✓ Retrieved config: azure.region = {azure_region}")
          
          # Load staging (should inherit from dev)
          config_mgr.load_environment("staging")
          staging_region = config_mgr.get_config("staging", "azure.region")
          print(f"✓ Staging inherits config: azure.region = {staging_region}")
          
          print("\n✓ All tests passed!")
          EOF

      - name: Test Module Loader Discovery
        run: |
          python3 << 'EOF'
          import sys
          import os
          sys.path.insert(0, os.getcwd())
          
          # Import and test the module loader
          from core.module_loader import ModuleLoader, ModuleManifest
          
          print("✓ Module loader imported successfully")
          
          # Create a module loader instance
          loader = ModuleLoader()
          print("✓ Module loader instance created")
          
          # Test that we can list modules (even if empty)
          modules = loader.list_modules()
          print(f"✓ Module loader can list modules: {len(modules)} found")
          
          print("\n✓ Module loader validation passed!")
          EOF

      - name: Validate Module Manifests
        run: |
          python3 << 'EOF'
          import yaml
          import os
          from pathlib import Path
          
          modules_dir = Path("modules/terraform")
          manifests_found = 0
          
          print("Validating Terraform module manifests...")
          
          for module_dir in modules_dir.iterdir():
              if not module_dir.is_dir():
                  continue
              
              manifest_file = module_dir / "module.yaml"
              if manifest_file.exists():
                  manifests_found += 1
                  print(f"\nValidating: {manifest_file}")
                  
                  with open(manifest_file, 'r') as f:
                      manifest = yaml.safe_load(f)
                  
                  # Check required fields
                  required_fields = ['name', 'version', 'type', 'description', 'author']
                  for field in required_fields:
                      if field not in manifest:
                          print(f"  ✗ Missing required field: {field}")
                          exit(1)
                      print(f"  ✓ {field}: {manifest[field]}")
                  
                  print(f"  ✓ Manifest is valid")
          
          print(f"\n✓ Validated {manifests_found} module manifests")
          EOF

  summary:
    name: Test Summary
    needs: [test]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Summary
        run: |
          echo "## Module Loader Tests Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Tests: ${{ needs.test.result }}" >> $GITHUB_STEP_SUMMARY
