name: PowerShell DSC Validation

on:
  push:
    paths:
      - 'modules/powershell-dsc/**'
      - '.github/workflows/dsc-validation.yml'
  pull_request:
    paths:
      - 'modules/powershell-dsc/**'

jobs:
  validate:
    name: Validate DSC Configurations
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PowerShell Modules
        shell: pwsh
        run: |
          # Install required modules
          Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser
          Write-Host "✓ PSScriptAnalyzer installed"

      - name: Analyze PowerShell Scripts
        shell: pwsh
        run: |
          $scriptFiles = Get-ChildItem -Path modules/powershell-dsc -Include *.ps1 -Recurse
          
          foreach ($script in $scriptFiles) {
            Write-Host "Analyzing: $($script.FullName)"
            $results = Invoke-ScriptAnalyzer -Path $script.FullName -Severity Warning,Error
            
            if ($results) {
              Write-Host "Issues found in $($script.Name):" -ForegroundColor Yellow
              $results | Format-Table -AutoSize
            } else {
              Write-Host "✓ No issues found" -ForegroundColor Green
            }
          }

      - name: Validate DSC Configuration Syntax
        shell: pwsh
        run: |
          $configFiles = Get-ChildItem -Path modules/powershell-dsc/configurations -Filter *.ps1
          
          foreach ($config in $configFiles) {
            Write-Host "Validating: $($config.Name)"
            
            try {
              # Test syntax by parsing the file
              $null = [System.Management.Automation.PSParser]::Tokenize((Get-Content $config.FullName -Raw), [ref]$null)
              Write-Host "✓ Syntax valid" -ForegroundColor Green
            }
            catch {
              Write-Host "✗ Syntax error: $_" -ForegroundColor Red
              exit 1
            }
          }

      - name: Test Configuration Compilation
        shell: pwsh
        run: |
          $configFiles = Get-ChildItem -Path modules/powershell-dsc/configurations -Filter *.ps1
          $tempOutput = "$env:TEMP\DSC_Test"
          
          New-Item -Path $tempOutput -ItemType Directory -Force | Out-Null
          
          foreach ($config in $configFiles) {
            Write-Host "Testing compilation: $($config.Name)"
            
            try {
              # Load the configuration
              . $config.FullName
              
              # Get the configuration function name (same as file name without extension)
              $configName = $config.BaseName
              
              Write-Host "✓ Configuration loaded successfully" -ForegroundColor Green
            }
            catch {
              Write-Host "✗ Failed to load configuration: $_" -ForegroundColor Red
              exit 1
            }
          }

  summary:
    name: Validation Summary
    needs: [validate]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Summary
        run: |
          echo "## PowerShell DSC Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Validation: ${{ needs.validate.result }}" >> $GITHUB_STEP_SUMMARY
