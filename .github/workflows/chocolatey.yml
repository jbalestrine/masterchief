name: Chocolatey Package

on:
  push:
    branches: [main]
    tags:
      - 'v*'
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build-chocolatey:
    runs-on: windows-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get version from setup.py
        id: get_version
        shell: pwsh
        run: |
          $content = Get-Content setup.py -Raw
          if ($content -match 'version="([^"]+)"') {
            $version = $Matches[1]
          } else {
            $version = "1.0.0"
          }
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT
          Write-Host "Package version: $version"

      - name: Update nuspec version
        shell: pwsh
        run: |
          $nuspecPath = "chocolatey/masterchief.nuspec"
          $content = Get-Content $nuspecPath -Raw
          $content = $content -replace '<version>[^<]+</version>', "<version>${{ steps.get_version.outputs.VERSION }}</version>"
          Set-Content -Path $nuspecPath -Value $content

      - name: Build Chocolatey package
        shell: pwsh
        run: |
          cd chocolatey
          choco pack masterchief.nuspec

      - name: Upload Chocolatey package artifact
        uses: actions/upload-artifact@v4
        with:
          name: chocolatey-package
          path: chocolatey/*.nupkg

  publish-chocolatey:
    runs-on: windows-latest
    needs: build-chocolatey
    if: github.event_name == 'release' || (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v'))
    permissions:
      contents: read

    steps:
      - name: Download Chocolatey package
        uses: actions/download-artifact@v4
        with:
          name: chocolatey-package
          path: chocolatey

      - name: Publish to Chocolatey Community Repository
        shell: pwsh
        env:
          CHOCOLATEY_API_KEY: ${{ secrets.CHOCOLATEY_API_KEY }}
        run: |
          if (-not $env:CHOCOLATEY_API_KEY) {
            Write-Warning "CHOCOLATEY_API_KEY secret not set. Skipping publish."
            exit 0
          }
          $package = Get-ChildItem -Path chocolatey -Filter *.nupkg | Select-Object -First 1
          if ($package) {
            Write-Host "Publishing $($package.Name) to Chocolatey..."
            choco apikey --key $env:CHOCOLATEY_API_KEY --source https://push.chocolatey.org/
            choco push $package.FullName --source https://push.chocolatey.org/
          } else {
            Write-Error "No .nupkg file found"
            exit 1
          }
