name: Ansible Validation

on:
  push:
    paths:
      - 'modules/ansible/**'
      - '.github/workflows/ansible-validation.yml'
  pull_request:
    paths:
      - 'modules/ansible/**'

jobs:
  validate:
    name: Validate Ansible Playbooks and Roles
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Ansible
        run: |
          pip install ansible==2.14.0
          pip install ansible-lint
          pip install yamllint

      - name: Install Azure Collection
        run: |
          ansible-galaxy collection install azure.azcollection

      - name: Validate Playbook Syntax
        run: |
          find modules/ansible/playbooks -name "*.yml" -o -name "*.yaml" | while read -r playbook; do
            echo "Validating $playbook"
            ansible-playbook --syntax-check "$playbook"
          done

      - name: Lint Ansible Code
        run: |
          cd modules/ansible
          ansible-lint playbooks/ roles/ || true
        continue-on-error: true

      - name: Lint YAML Files
        run: |
          yamllint -c .yamllint modules/ansible/ || true
        continue-on-error: true

      - name: Validate Inventory
        run: |
          ansible-inventory -i modules/ansible/inventory/azure_rm.yml --list > /dev/null || true
        continue-on-error: true

      - name: Check Role Structure
        run: |
          for role in modules/ansible/roles/*; do
            if [ -d "$role" ]; then
              echo "Checking role: $(basename $role)"
              
              # Check for required directories
              required_dirs=("tasks" "defaults" "meta")
              for dir in "${required_dirs[@]}"; do
                if [ ! -d "$role/$dir" ]; then
                  echo "  ✗ Missing $dir directory"
                else
                  echo "  ✓ $dir directory exists"
                fi
              done
              
              # Check for main.yml in tasks
              if [ -f "$role/tasks/main.yml" ]; then
                echo "  ✓ tasks/main.yml exists"
              else
                echo "  ✗ tasks/main.yml missing"
              fi
            fi
          done

  summary:
    name: Validation Summary
    needs: [validate]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Summary
        run: |
          echo "## Ansible Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Validation: ${{ needs.validate.result }}" >> $GITHUB_STEP_SUMMARY
