# DevOps Master Suite - Complete Project Generator
# This script creates all necessary files and packages them into a zip

$projectName = "DevOps-Master-Suite"
$basePath = "$env:USERPROFILE\Downloads\$projectName"

Write-Host "============================================" -ForegroundColor Cyan
Write-Host "DevOps Master Suite - Project Generator" -ForegroundColor Cyan
Write-Host "============================================" -ForegroundColor Cyan
Write-Host "Creating project at: $basePath" -ForegroundColor Yellow

# Create directory structure
New-Item -ItemType Directory -Path "$basePath\backend" -Force | Out-Null
New-Item -ItemType Directory -Path "$basePath\backend\scripts" -Force | Out-Null
New-Item -ItemType Directory -Path "$basePath\backend\logs" -Force | Out-Null
New-Item -ItemType Directory -Path "$basePath\frontend\src" -Force | Out-Null
New-Item -ItemType Directory -Path "$basePath\frontend\public" -Force | Out-Null
New-Item -ItemType Directory -Path "$basePath\docs" -Force | Out-Null

Write-Host "`nâœ“ Directory structure created" -ForegroundColor Green

# ==================== BACKEND FILES ====================

# server.js
@'
const express = require('express');
const cors = require('cors');
const bodyParser = require('body-parser');
const path = require('path');
const fs = require('fs').promises;
const { spawn } = require('child_process');
const sqlite3 = require('sqlite3').verbose();
const dotenv = require('dotenv');

dotenv.config();

const app = express();
const PORT = process.env.PORT || 5000;
const SCRIPTS_DIR = path.join(__dirname, 'scripts');
const LOGS_DIR = path.join(__dirname, 'logs');
const DB_FILE = path.join(__dirname, 'devops.db');

app.use(cors());
app.use(bodyParser.json({ limit: '50mb' }));
app.use(bodyParser.urlencoded({ limit: '50mb', extended: true }));

const db = new sqlite3.Database(DB_FILE, (err) => {
  if (err) console.error('Database connection error:', err);
  else console.log('âœ“ Connected to SQLite database');
  initializeDatabase();
});

async function initializeDatabase() {
  const dirs = [SCRIPTS_DIR, LOGS_DIR];
  for (const dir of dirs) {
    try {
      await fs.mkdir(dir, { recursive: true });
    } catch (e) {}
  }

  db.serialize(() => {
    db.run(`
      CREATE TABLE IF NOT EXISTS scripts (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        name TEXT UNIQUE NOT NULL,
        category TEXT NOT NULL,
        description TEXT,
        content TEXT NOT NULL,
        createdAt DATETIME DEFAULT CURRENT_TIMESTAMP,
        updatedAt DATETIME DEFAULT CURRENT_TIMESTAMP,
        execCount INTEGER DEFAULT 0,
        lastRun DATETIME,
        avgDuration REAL DEFAULT 0
      )
    `);

    db.run(`
      CREATE TABLE IF NOT EXISTS execution_logs (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        scriptName TEXT NOT NULL,
        status TEXT NOT NULL,
        output TEXT,
        duration REAL,
        executedAt DATETIME DEFAULT CURRENT_TIMESTAMP,
        exitCode INTEGER,
        FOREIGN KEY(scriptName) REFERENCES scripts(name)
      )
    `);

    db.run(`
      CREATE TABLE IF NOT EXISTS resources (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        name TEXT UNIQUE NOT NULL,
        type TEXT NOT NULL,
        status TEXT NOT NULL,
        cost REAL DEFAULT 0,
        region TEXT NOT NULL,
        metadata TEXT,
        createdAt DATETIME DEFAULT CURRENT_TIMESTAMP,
        updatedAt DATETIME DEFAULT CURRENT_TIMESTAMP
      )
    `);

    db.run(`
      CREATE TABLE IF NOT EXISTS config (
        key TEXT PRIMARY KEY,
        value TEXT,
        updatedAt DATETIME DEFAULT CURRENT_TIMESTAMP
      )
    `);
  });
}

// SCRIPTS
app.get('/api/scripts', (req, res) => {
  db.all('SELECT * FROM scripts ORDER BY name ASC', (err, rows) => {
    if (err) return res.status(500).json({ error: err.message });
    res.json(rows || []);
  });
});

app.post('/api/scripts', (req, res) => {
  const { name, category, description, content } = req.body;
  if (!name || !content) return res.status(400).json({ error: 'Name and content required' });
  
  db.run(
    'INSERT INTO scripts (name, category, description, content) VALUES (?, ?, ?, ?)',
    [name, category, description, content],
    function (err) {
      if (err) return res.status(500).json({ error: err.message });
      saveScriptFile(name, content);
      res.status(201).json({ id: this.lastID, name, category, description, content, execCount: 0 });
    }
  );
});

app.put('/api/scripts/:id', (req, res) => {
  const { name, category, description, content } = req.body;
  db.run(
    'UPDATE scripts SET name = ?, category = ?, description = ?, content = ?, updatedAt = CURRENT_TIMESTAMP WHERE id = ?',
    [name, category, description, content, req.params.id],
    function (err) {
      if (err) return res.status(500).json({ error: err.message });
      saveScriptFile(name, content);
      res.json({ message: 'Script updated' });
    }
  );
});

app.delete('/api/scripts/:id', (req, res) => {
  db.get('SELECT name FROM scripts WHERE id = ?', [req.params.id], (err, row) => {
    if (err) return res.status(500).json({ error: err.message });
    if (!row) return res.status(404).json({ error: 'Script not found' });
    db.run('DELETE FROM scripts WHERE id = ?', [req.params.id], (err) => {
      if (err) return res.status(500).json({ error: err.message });
      res.json({ message: 'Script deleted' });
    });
  });
});

// EXECUTION
app.post('/api/execute', (req, res) => {
  const { scriptName, params = {} } = req.body;
  if (!scriptName) return res.status(400).json({ error: 'Script name required' });

  db.get('SELECT content FROM scripts WHERE name = ?', [scriptName], (err, row) => {
    if (err) return res.status(500).json({ error: err.message });
    if (!row) return res.status(404).json({ error: 'Script not found' });

    const startTime = Date.now();
    const ps = spawn('powershell.exe', [
      '-NoProfile', '-ExecutionPolicy', 'Bypass',
      '-File', path.join(SCRIPTS_DIR, scriptName),
      ...flattenParams(params)
    ]);

    let stdout = '', stderr = '';
    ps.stdout.on('data', (data) => { stdout += data.toString(); });
    ps.stderr.on('data', (data) => { stderr += data.toString(); });
    
    ps.on('close', (code) => {
      const duration = (Date.now() - startTime) / 1000;
      const status = code === 0 ? 'success' : 'failed';
      db.run(
        `INSERT INTO execution_logs (scriptName, status, output, duration, exitCode) VALUES (?, ?, ?, ?, ?)`,
        [scriptName, status, stdout + stderr, duration, code]
      );
      res.json({ status, output: stdout + stderr, duration: duration.toFixed(2), exitCode: code });
    });

    ps.on('error', (err) => {
      res.status(500).json({ error: 'Execution failed', message: err.message });
    });
  });
});

// RESOURCES
app.get('/api/resources', (req, res) => {
  db.all('SELECT * FROM resources ORDER BY name ASC', (err, rows) => {
    if (err) return res.status(500).json({ error: err.message });
    res.json(rows || []);
  });
});

app.post('/api/resources', (req, res) => {
  const { name, type, status, cost, region, metadata } = req.body;
  db.run(
    'INSERT INTO resources (name, type, status, cost, region, metadata) VALUES (?, ?, ?, ?, ?, ?)',
    [name, type, status, cost, region, JSON.stringify(metadata || {})],
    function (err) {
      if (err) return res.status(500).json({ error: err.message });
      res.status(201).json({ id: this.lastID, name, type, status, cost, region, metadata });
    }
  );
});

// LOGS
app.get('/api/logs', (req, res) => {
  const limit = req.query.limit || 50;
  db.all('SELECT * FROM execution_logs ORDER BY executedAt DESC LIMIT ?', [limit], (err, rows) => {
    if (err) return res.status(500).json({ error: err.message });
    res.json(rows || []);
  });
});

// CONFIG
app.get('/api/config', (req, res) => {
  db.all('SELECT key, value FROM config', (err, rows) => {
    const config = {};
    (rows || []).forEach(row => { config[row.key] = row.value; });
    res.json(config);
  });
});

// STATS
app.get('/api/stats', (req, res) => {
  const stats = {};
  db.get('SELECT COUNT(*) as count FROM scripts', (err, row) => {
    stats.totalScripts = row?.count || 0;
  });
  db.get('SELECT COUNT(*) as count FROM resources WHERE status = "running"', (err, row) => {
    stats.activeResources = row?.count || 0;
    res.json(stats);
  });
});

async function saveScriptFile(name, content) {
  try {
    await fs.mkdir(SCRIPTS_DIR, { recursive: true });
    await fs.writeFile(path.join(SCRIPTS_DIR, name), content, 'utf8');
  } catch (err) {
    console.error('Error saving script file:', err);
  }
}

function flattenParams(params) {
  const result = [];
  for (const [key, value] of Object.entries(params)) {
    result.push(`-${key}`);
    result.push(String(value));
  }
  return result;
}

app.use((err, req, res, next) => {
  console.error('Server error:', err);
  res.status(500).json({ error: 'Internal server error', message: err.message });
});

app.listen(PORT, () => {
  console.log(`âœ“ DevOps Master Suite API running on http://localhost:${PORT}`);
});
'@ | Set-Content "$basePath\backend\server.js" -Force

# package.json
@'
{
  "name": "devops-master-suite",
  "version": "1.0.0",
  "description": "Enterprise DevOps automation platform",
  "main": "server.js",
  "scripts": {
    "start": "node server.js",
    "dev": "nodemon server.js",
    "seed": "node seed-database.js"
  },
  "dependencies": {
    "express": "^4.18.2",
    "cors": "^2.8.5",
    "body-parser": "^1.20.2",
    "sqlite3": "^5.1.6",
    "dotenv": "^16.3.1",
    "axios": "^1.6.2"
  },
  "devDependencies": {
    "nodemon": "^3.0.2"
  },
  "engines": {
    "node": ">=14.0.0"
  }
}
'@ | Set-Content "$basePath\backend\package.json" -Force

# .env
@'
PORT=5000
NODE_ENV=development

AZURE_SUBSCRIPTION_ID=your-subscription-id
AZURE_TENANT_ID=your-tenant-id
AZURE_CLIENT_ID=your-client-id
AZURE_CLIENT_SECRET=your-client-secret

DEFAULT_REGION=eastus
NAMING_PATTERN=[env]-[type]-[location]-[instance]
API_ENDPOINT=http://localhost:5000

SCRIPT_TIMEOUT=3600000
MAX_SCRIPT_SIZE=10485760
'@ | Set-Content "$basePath\backend\.env" -Force

# seed-database.js
@'
const sqlite3 = require('sqlite3').verbose();
const path = require('path');

const DB_FILE = path.join(__dirname, 'devops.db');
const db = new sqlite3.Database(DB_FILE);

const INITIAL_RESOURCES = [
  { name: 'prod-rg-eastus-001', type: 'Resource Group', status: 'running', cost: 1245, region: 'East US' },
  { name: 'prod-vnet-hub-001', type: 'Virtual Network', status: 'running', cost: 45, region: 'East US' },
  { name: 'prod-sql-cluster-001', type: 'SQL HA Cluster', status: 'running', cost: 3890, region: 'East US' },
  { name: 'prod-webapp-ilb-001', type: 'WebApp Cluster', status: 'running', cost: 567, region: 'East US' },
  { name: 'dev-rg-eastus-002', type: 'Resource Group', status: 'stopped', cost: 0, region: 'East US' },
  { name: 'prod-aks-cluster-001', type: 'AKS Cluster', status: 'running', cost: 2150, region: 'West US' },
  { name: 'prod-kv-eastus-001', type: 'Key Vault', status: 'running', cost: 12, region: 'East US' }
];

db.serialize(() => {
  console.log('Seeding resources...');
  INITIAL_RESOURCES.forEach(resource => {
    db.run(
      'INSERT OR IGNORE INTO resources (name, type, status, cost, region) VALUES (?, ?, ?, ?, ?)',
      [resource.name, resource.type, resource.status, resource.cost, resource.region],
      (err) => {
        if (err) console.error(`Error: ${resource.name}`);
        else console.log(`âœ“ ${resource.name}`);
      }
    );
  });

  const config = {
    'DEFAULT_REGION': 'eastus',
    'NAMING_PATTERN': '[env]-[type]-[location]-[instance]',
    'SCRIPT_TIMEOUT': '3600000',
    'API_VERSION': '1.0'
  };

  console.log('Seeding configuration...');
  Object.entries(config).forEach(([key, value]) => {
    db.run(
      'INSERT OR REPLACE INTO config (key, value) VALUES (?, ?)',
      [key, value],
      (err) => {
        if (!err) console.log(`âœ“ ${key}`);
      }
    );
  });
});

db.close(() => {
  console.log('\nâœ“ Database seeding completed!');
});
'@ | Set-Content "$basePath\backend\seed-database.js" -Force

Write-Host "`nâœ“ Backend files created" -ForegroundColor Green

# ==================== FRONTEND FILES ====================

# DevOpsMasterSuite.tsx (Fixed version)
@'
import React, { useState, useEffect } from ''react'';
import { Cloud, Server, Database, Network, Terminal, Settings, PlayCircle, StopCircle, List, Plus, FileCode, GitBranch, Layers, Edit, Save, X, Check, AlertCircle, Upload, Download, DollarSign, Activity, Shield, Bell, RefreshCw, Trash2, Copy, Eye, Clock, TrendingUp, Package, Code } from ''lucide-react'';

const DevOpsMasterSuite = () => {
  const [activeTab, setActiveTab] = useState(''dashboard'');
  const [selectedCategory, setSelectedCategory] = useState(null);
  const [editingScript, setEditingScript] = useState(null);
  const [scriptContent, setScriptContent] = useState('''');
  const [executionLog, setExecutionLog] = useState([]);
  const [showExecutionPanel, setShowExecutionPanel] = useState(false);
  const [showUploadModal, setShowUploadModal] = useState(false);
  const [showTemplateGenerator, setShowTemplateGenerator] = useState(false);
  const [searchQuery, setSearchQuery] = useState('''');
  const [selectedScript, setSelectedScript] = useState(null);
  const [uploadFileName, setUploadFileName] = useState('''');
  const [uploadCategory, setUploadCategory] = useState(''Deployment'');
  const [uploadContent, setUploadContent] = useState('''');

  const [scripts, setScripts] = useState([
    { id: 1, name: ''Deploy-AzureEnvironment.ps1'', category: ''Deployment'', description: ''Deploy complete Azure environment with RG, VNet, Subnets, NSGs'', lastRun: ''2 hours ago'', execCount: 145, avgDuration: ''4.2 min'', content: ''# Script content here'' },
    { id: 2, name: ''Set-NamingStandard.ps1'', category: ''Standards'', description: ''Universal naming convention generator for all Azure resources'', lastRun: ''Never'', execCount: 0, avgDuration: ''< 1 sec'', content: ''# Script content here'' },
    { id: 3, name: ''New-SQLHACluster.ps1'', category: ''Database'', description: ''Deploy SQL Server Always On HA Cluster with ILB'', lastRun: ''3 days ago'', execCount: 12, avgDuration: ''25 min'', content: ''# Script content here'' },
    { id: 4, name: ''New-WebAppCluster.ps1'', category: ''WebApp'', description: ''Deploy App Service cluster with auto-scaling behind ILB'', lastRun: ''5 hours ago'', execCount: 34, avgDuration: ''8 min'', content: ''# Script content here'' }
  ]);

  const [resources, setResources] = useState([
    { id: 1, name: ''prod-rg-eastus-001'', type: ''Resource Group'', status: ''running'', cost: 1245, region: ''East US'' },
    { id: 2, name: ''prod-vnet-hub-001'', type: ''Virtual Network'', status: ''running'', cost: 45, region: ''East US'' },
    { id: 3, name: ''prod-sql-cluster-001'', type: ''SQL HA Cluster'', status: ''running'', cost: 3890, region: ''East US'' },
    { id: 4, name: ''prod-webapp-ilb-001'', type: ''WebApp Cluster'', status: ''running'', cost: 567, region: ''East US'' },
    { id: 5, name: ''dev-rg-eastus-002'', type: ''Resource Group'', status: ''stopped'', cost: 0, region: ''East US'' },
    { id: 6, name: ''prod-aks-cluster-001'', type: ''AKS Cluster'', status: ''running'', cost: 2150, region: ''West US'' },
    { id: 7, name: ''prod-kv-eastus-001'', type: ''Key Vault'', status: ''running'', cost: 12, region: ''East US'' }
  ]);

  const totalCost = resources.reduce((sum, r) => sum + r.cost, 0);
  const runningResources = resources.filter(r => r.status === ''running'').length;

  const executeScript = (script) => {
    const timestamp = new Date().toLocaleTimeString();
    setExecutionLog(prev => [{
      id: Date.now(),
      script: script.name,
      timestamp: timestamp,
      status: ''success'',
      output: `[${timestamp}] Script executed successfully`
    }, ...prev]);
    setShowExecutionPanel(true);
    setScripts(prev => prev.map(s => 
      s.id === script.id ? { ...s, lastRun: ''Just now'', execCount: s.execCount + 1 } : s
    ));
  };

  const saveScript = () => {
    if(editingScript) {
      setScripts(prev => prev.map(s => 
        s.id === editingScript.id ? {...s, content: scriptContent} : s
      ));
      setEditingScript(null);
    }
  };

  const handleUploadScript = () => {
    if(uploadFileName && uploadContent) {
      const newScript = {
        id: scripts.length + 1,
        name: uploadFileName,
        category: uploadCategory,
        description: ''Custom uploaded script'',
        lastRun: ''Never'',
        execCount: 0,
        avgDuration: ''< 1 sec'',
        content: uploadContent
      };
      setScripts(prev => [...prev, newScript]);
      setShowUploadModal(false);
      setUploadFileName('''');
      setUploadContent('''');
    }
  };

  const deleteScript = (scriptId) => {
    if(confirm(''Are you sure?'')) {
      setScripts(prev => prev.filter(s => s.id !== scriptId));
    }
  };

  const filteredScripts = scripts.filter(s => 
    s.name.toLowerCase().includes(searchQuery.toLowerCase())
  );

  return (
    <div className="min-h-screen bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900">
      <div className="bg-gradient-to-r from-blue-600 to-purple-600 text-white shadow-lg">
        <div className="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
          <div className="flex items-center gap-3">
            <Cloud className="w-8 h-8" />
            <h1 className="text-2xl font-bold">DevOps Master Suite</h1>
          </div>
          <div className="text-sm text-blue-100">v1.0 â€¢ Enterprise Edition</div>
        </div>
      </div>

      <div className="bg-gray-800 border-b border-gray-700">
        <div className="max-w-7xl mx-auto px-6">
          {[
            { id: ''dashboard'', icon: Activity, label: ''Dashboard'' },
            { id: ''scripts'', icon: Terminal, label: ''PowerShell Scripts'' },
            { id: ''resources'', icon: Server, label: ''Resources'' }
          ].map(tab => (
            <button
              key={tab.id}
              onClick={() => setSelectedCategory(tab.id === ''dashboard'' ? null : tab.id)}
              className={`px-6 py-4 font-medium flex items-center gap-2 transition-colors border-b-2 ${
                (tab.id === ''dashboard'' && !selectedCategory) || selectedCategory === tab.id
                  ? ''text-blue-400 border-blue-400''
                  : ''text-gray-400 border-transparent hover:text-gray-200''
              }`}>
              <tab.icon className="w-4 h-4" />
              {tab.label}
            </button>
          ))}
        </div>
      </div>

      <div className="max-w-7xl mx-auto px-6 py-8">
        <div className="space-y-6">
          <div className="text-white text-2xl font-bold">DevOps Master Suite Ready</div>
          <div className="bg-white p-6 rounded-lg border border-gray-200">
            <p className="text-gray-700">Scripts: {scripts.length} | Resources: {resources.length} | Total Cost: ${(totalCost/1000).toFixed(1)}K</p>
          </div>
        </div>
      </div>

      <div className="bg-gray-800 border-t border-gray-700 mt-12">
        <div className="max-w-7xl mx-auto px-6 py-6 text-center text-gray-400 text-sm">
          DevOps Master Suite Â© 2024 | Built for Enterprise Cloud Operations
        </div>
      </div>
    </div>
  );
};

export default DevOpsMasterSuite;
'@ | Set-Content "$basePath\frontend\src\DevOpsMasterSuite.tsx" -Force

Write-Host "âœ“ Frontend files created" -ForegroundColor Green

# ==================== DOCUMENTATION ====================

@'
# DevOps Master Suite - Complete Setup Guide

## Project Structure