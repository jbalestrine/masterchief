---
# Common role - Base configuration for all Linux servers

- name: Update package cache
  apt:
    update_cache: yes
    cache_valid_time: 3600
  when: ansible_os_family == "Debian"

- name: Update package cache (RedHat)
  yum:
    update_cache: yes
  when: ansible_os_family == "RedHat"

- name: Install common packages
  package:
    name: "{{ common_packages }}"
    state: present

- name: Create admin users
  user:
    name: "{{ item.name }}"
    groups: "{{ item.groups | default(['sudo']) }}"
    shell: "{{ item.shell | default('/bin/bash') }}"
    state: present
  loop: "{{ admin_users }}"
  when: admin_users is defined

- name: Set up SSH keys for admin users
  authorized_key:
    user: "{{ item.name }}"
    key: "{{ item.ssh_key }}"
    state: present
  loop: "{{ admin_users }}"
  when: admin_users is defined and item.ssh_key is defined

- name: Configure timezone
  timezone:
    name: "{{ system_timezone }}"
  when: system_timezone is defined

- name: Configure NTP
  include_tasks: ntp.yml
  when: configure_ntp | default(true)

- name: Configure firewall
  include_tasks: firewall.yml
  when: configure_firewall | default(true)

- name: Set up log rotation
  template:
    src: logrotate.conf.j2
    dest: /etc/logrotate.d/masterchief
    mode: '0644'

- name: Install monitoring agent
  include_tasks: monitoring.yml
  when: enable_monitoring | default(false)
