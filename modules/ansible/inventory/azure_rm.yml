# Azure Resource Manager Dynamic Inventory Configuration
# This uses the azure.azcollection.azure_rm inventory plugin

plugin: azure.azcollection.azure_rm

# Authentication
# Uses environment variables:
# - AZURE_SUBSCRIPTION_ID
# - AZURE_CLIENT_ID
# - AZURE_SECRET
# - AZURE_TENANT
auth_source: auto

# Include VM power state
include_vm_resource_groups:
  - "*"

# Conditional groups based on tags
conditional_groups:
  # Group by environment tag
  dev: "tags.environment == 'dev'"
  staging: "tags.environment == 'staging'"
  prod: "tags.environment == 'prod'"
  
  # Group by role tag
  webserver: "tags.role == 'webserver'"
  appserver: "tags.role == 'appserver'"
  database: "tags.role == 'database'"
  
  # Group by managed_by tag
  masterchief: "tags.managed_by == 'masterchief'"

# Keyed groups
keyed_groups:
  # Group by resource group
  - key: resource_group
    prefix: rg
    separator: "_"
  
  # Group by location
  - key: location
    prefix: location
    separator: "_"
  
  # Group by OS type
  - key: os_profile.system
    prefix: os
    separator: "_"

# Hostvar composition
compose:
  # Use private IP for connection
  ansible_host: private_ipv4_addresses[0]
  
  # Set connection type based on OS
  ansible_connection: "'winrm' if os_profile.system == 'Windows' else 'ssh'"
  
  # Set Python interpreter
  ansible_python_interpreter: "'/usr/bin/python3' if os_profile.system == 'Linux' else None"

# Exclude powered off VMs
exclude_host_filters:
  - powerstate != 'running'

# Use Azure naming for group names
use_contrib_script_compatible_sanitization: true

# Plain groups (no prefix)
plain_host_names: false
