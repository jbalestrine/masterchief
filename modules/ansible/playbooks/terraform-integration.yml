---
# Terraform Output Integration Playbook
# This playbook demonstrates how to integrate Terraform outputs with Ansible
# Usage: ansible-playbook playbooks/terraform-integration.yml -e "@terraform_outputs.json"

- name: Configure infrastructure from Terraform outputs
  hosts: localhost
  gather_facts: no
  tasks:
    - name: Display Terraform outputs
      debug:
        var: terraform_outputs
      when: terraform_outputs is defined

    - name: Add hosts from Terraform dynamically
      add_host:
        name: "{{ item.value.public_ip }}"
        groups: "{{ item.value.role }}"
        ansible_host: "{{ item.value.private_ip }}"
      loop: "{{ terraform_outputs.vm_details | dict2items }}"
      when: terraform_outputs.vm_details is defined

- name: Configure dynamically added hosts
  hosts: all:!localhost
  become: yes
  tasks:
    - name: Wait for systems to be reachable
      wait_for_connection:
        timeout: 300

    - name: Gather facts
      setup:

    - name: Apply common configuration
      include_role:
        name: common
